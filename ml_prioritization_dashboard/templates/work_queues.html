<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boston 311 Work Queues & Assignment</title>

  <!-- Modern font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-shell: #f5f7fb;
      --bg-card: #ffffff;
      --bg-card-soft: #f8fafc;
      --border-subtle: #e2e8f0;

      --nav-bg: #021b3b;
      --nav-bg-alt: #0b2648;
      --nav-border: #0f2f5f;

      --accent-blue: #2563eb;
      --accent-red: #ff4c4c;

      --text-main: #0f172a;
      --text-muted: #6b7280;

      --prio-high: #b91c1c;
      --prio-med: #f97316;
      --prio-low: #16a34a;
    }

    body.dark-mode {
      --bg-shell: #020617;
      --bg-card: #02081f;
      --bg-card-soft: #020617;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-shell);
      color: var(--text-main);
    }

    .top-nav {
      background: linear-gradient(90deg, var(--nav-bg), var(--nav-bg-alt));
      border-bottom: 1px solid var(--nav-border);
      color: #f9fafb;
      padding: 10px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .top-nav-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .city-badge {
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.6);
      padding: 4px 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .top-nav-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .top-nav-title-main {
      font-size: 20px;
      font-weight: 600;
    }

    .top-nav-title-sub {
      font-size: 12px;
      opacity: 0.85;
    }

    .top-nav-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
    }

    .env-pill {
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid rgba(148,163,184,0.5);
      color: #e5e7eb;
      background: rgba(15,23,42,0.4);
    }

    .system-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(34,197,94,0.05);
      border: 1px solid rgba(34,197,94,0.3);
      color: #bbf7d0;
      font-weight: 500;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.35);
    }

    .page-shell {
      padding: 20px 32px 40px;
    }

    @media (max-width: 768px) {
      .top-nav, .page-shell { padding-inline: 16px; }
    }

    /* Tabs with Command Center */
    .page-tabs {
      margin-bottom: 10px;
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 2px;
      gap: 2px;
    }

    .page-tab {
      padding: 5px 12px;
      font-size: 11px;
      border-radius: 999px;
      text-decoration: none;
      color: #374151;
      font-weight: 500;
    }

    .page-tab-active {
      background: #ffffff;
      color: #111827;
    }

    .hero-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
      border: 1px solid var(--border-subtle);
      margin-bottom: 14px;
    }

    .hero-title {
      font-size: 22px;
      font-weight: 650;
      margin-bottom: 4px;
    }

    .hero-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 700px;
    }

    .hero-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* Department selector */

    .filters-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 10px 14px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 12px;
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .filters-title {
      font-size: 13px;
      font-weight: 600;
    }

    .filters-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-right: 3px;
    }

    select {
      padding: 5px 8px;
      border-radius: 7px;
      border: 1px solid #cbd5e1;
      background: #f9fafb;
      font-size: 12px;
      min-width: 200px;
    }

    select:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
      background: #ffffff;
    }

    .btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
      color: white;
      box-shadow: 0 4px 12px rgba(37,99,235,0.36);
    }

    /* Queue cards */

    .dept-header-card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 10px 14px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .dept-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .dept-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .queue-list-card {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 6px 0;
    }

    .queue-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 8px 14px;
      border-top: 1px solid #e5e7eb;
      font-size: 12px;
    }

    .queue-item:first-child {
      border-top: none;
    }

    .queue-main {
      flex: 1;
      min-width: 0;
    }

    .queue-title {
      font-size: 13px;
      font-weight: 600;
    }

    .queue-title a {
      color: var(--accent-blue);
      text-decoration: none;
    }

    .queue-title a:hover {
      text-decoration: underline;
    }

    .queue-subline {
      margin-top: 2px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .queue-tags {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid transparent;
      background: #f3f4f6;
      color: #374151;
    }

    .tag-segment {
      background: #fee2e2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .tag-status {
      background: #e0f2fe;
      border-color: #bae6fd;
      color: #075985;
    }

    .tag-priority-high {
      background: #fee2e2;
      border-color: #fecaca;
      color: #b91c1c;
    }

    .tag-priority-med {
      background: #ffedd5;
      border-color: #fed7aa;
      color: #9a3412;
    }

    .tag-priority-low {
      background: #dcfce7;
      border-color: #bbf7d0;
      color: #166534;
    }

    .queue-buttons {
      margin-top: 6px;
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .queue-btn {
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      font-size: 11px;
      cursor: pointer;
    }

    .queue-btn-primary {
      border-color: var(--accent-blue);
      background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
      color: #ffffff;
    }

    .queue-side {
      min-width: 80px;
      text-align: right;
      font-size: 11px;
      margin-left: 10px;
      color: var(--accent-red);
    }

    .queue-score {
      font-weight: 700;
      font-size: 14px;
    }

    .queue-rank {
      color: var(--text-muted);
      margin-top: 2px;
    }

    .empty-text {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }
  </style>
</head>
<body>

  <div class="top-nav">
    <div class="top-nav-left">
      <div class="city-badge">City of Boston</div>
      <div class="top-nav-title">
        <div class="top-nav-title-main">311 Work Queues</div>
        <div class="top-nav-title-sub">
          Supervisor view for assigning crews and tracking work in progress.
        </div>
      </div>
    </div>
    <div class="top-nav-right">
      <div class="env-pill">Environment: Internal • Pilot model v1.0</div>
      <div class="system-status-pill">
        <span class="status-dot"></span>
        System online
      </div>
    </div>
  </div>

  <div class="page-shell">
    <!-- Tabs -->
    <div class="page-tabs">
    <a href="/" class="page-tab">Command Center</a>
    <a href="/work-queues" class="page-tab page-tab-active">Work Queues</a>
    <a href="/neighborhoods" class="page-tab">Neighborhood performance</a>
    <a href="/sla-performance" class="page-tab">SLA performance</a>
    <a href="/demand-trends" class="page-tab">Demand trends</a>
    <a href="/analytics" class="page-tab page-tab-active">Analytics</a>
    </div>

    <div class="hero-card">
      <div class="hero-title">Work Queues &amp; Assignment</div>
      <div class="hero-subtitle">
        Use this page during a shift to see which department queues are heaviest,
        which cases are still unassigned, and where the highest-priority work sits.
      </div>
      <div class="hero-meta">
        Queues use the same ML priority score as the Command Center. Start by picking
        a department below.
      </div>
    </div>

    <!-- Department selector -->
    <div class="filters-card">
      <div class="filters-header">
        <div class="filters-title">Department queue</div>
        <div class="filters-hint">Choose a department to see its work queue.</div>
      </div>
      <form method="get" action="/work-queues" class="filters-row">
        <label for="department">Department</label>
        <select id="department" name="department">
          <option value="" {% if not sel_dept %}selected{% endif %}>Select a department…</option>
          {% for d in departments %}
            <option value="{{ d }}" {% if sel_dept == d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn">Show queue</button>
      </form>
    </div>

    {% if not sel_dept %}
      <div class="dept-header-card">
        <div class="dept-name">No department selected</div>
        <div class="dept-meta">
          Pick a department above to see its open cases, ordered by ML priority score.
        </div>
      </div>
    {% else %}
      <div class="dept-header-card">
        <div class="dept-name">{{ sel_dept }}</div>
        {% if stats %}
          <div class="dept-meta">
            {{ stats.total_open }} open cases
            {% if stats.num_crit > 0 %} • {{ stats.num_crit }} critical{% endif %}
            {% if stats.avg_score %} • Avg priority score {{ stats.avg_score }}{% endif %}
          </div>
        {% else %}
          <div class="dept-meta">
            No open cases in this department for the current data.
          </div>
        {% endif %}
      </div>

      {% if work_queue|length == 0 %}
        <div class="queue-list-card">
          <div class="empty-text" style="padding:8px 14px;">
            No open cases found for {{ sel_dept }}.
          </div>
        </div>
      {% else %}
        <div class="queue-list-card">
          {% for row in work_queue %}
            <div class="queue-item">
              <div class="queue-main">
                <div class="queue-title">
                  <a href="#case-{{ row.case_enquiry_id }}">Case {{ row.case_enquiry_id }}</a>
                </div>
                <div class="queue-subline">
                  {{ row.neighborhood or "Unknown neighborhood" }}
                  {% if row.reason %} • {{ row.reason }}{% endif %}
                </div>

                <div class="queue-tags">
                  {% if row.segment %}
                    <span class="tag tag-segment">{{ row.segment }}</span>
                  {% endif %}
                  <span class="tag tag-status">Unassigned</span>

                  {% if row.priority_score is defined %}
                    {% if row.priority_score >= 0.9 %}
                      <span class="tag tag-priority-high">High priority</span>
                    {% elif row.priority_score >= 0.7 %}
                      <span class="tag tag-priority-med">Medium priority</span>
                    {% else %}
                      <span class="tag tag-priority-low">Lower priority</span>
                    {% endif %}
                  {% endif %}
                </div>

                <div class="queue-buttons">
                  <button type="button" class="queue-btn queue-btn-primary queue-btn-action">Assign to crew…</button>
                  <button type="button" class="queue-btn queue-btn-action">Mark in-progress</button>
                  <button type="button" class="queue-btn queue-btn-action">Add note</button>
                </div>
              </div>

              <div class="queue-side">
                {% if row.priority_score is defined %}
                  <div class="queue-score">{{ "%.3f"|format(row.priority_score) }}</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endif %}

    {% if sel_dept and work_queue|length > 0 %}
      <div class="empty-text" style="margin-top:8px;">
        Showing up to the top 100 cases by priority for {{ sel_dept }}.
      </div>
    {% endif %}
  </div>

  <script>
    // Reuse dark mode setting from Command Center
    if (localStorage.getItem("b311_dark") === "true") {
      document.body.classList.add("dark-mode");
    }

    // Prototype actions for the three buttons
    document.querySelectorAll(".queue-btn-action").forEach(btn => {
      btn.addEventListener("click", () => {
        alert("This is a prototype UI. In a full version this button would open an assignment or notes panel.");
      });
    });
  </script>
</body>
</html>
