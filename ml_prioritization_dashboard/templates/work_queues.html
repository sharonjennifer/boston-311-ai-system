<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boston 311 Work Queues & Assignment</title>

  <!-- Inter font so this page visually matches the rest of the dashboard -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Page-specific CSS for the Work Queues view -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/work_queues.css') }}">
</head>
<body>

  <!-- Shared top navigation bar -->
  <div class="top-nav">
    <div class="top-nav-left">
      <div class="city-badge">City of Boston</div>
      <div class="top-nav-title">
        <div class="top-nav-title-main">311 Work Queues</div>
        <div class="top-nav-title-sub">
          Supervisor view for assigning crews and tracking work in progress.
        </div>
      </div>
    </div>
    <div class="top-nav-right">
      <div class="env-pill">Environment: Internal • Pilot model v1.0</div>
      <div class="system-status-pill">
        <span class="status-dot"></span>
        System online
      </div>
    </div>
  </div>

  <div class="page-shell">
    <!-- Tab navigation (Command Center, Work Queues, Neighborhoods, etc.) -->
    <div class="page-tabs">
      <a href="/" class="page-tab">Command Center</a>
      <a href="/work-queues" class="page-tab page-tab-active">Work Queues</a>
      <a href="/neighborhoods" class="page-tab">Neighborhood performance</a>
      <a href="/sla-performance" class="page-tab">SLA performance</a>
      <a href="/demand-trends" class="page-tab">Demand trends</a>
      <a href="/analytics" class="page-tab">Analytics</a>
    </div>

    <!-- Hero block explaining how to use this page -->
    <div class="hero-card">
      <div class="hero-title">Work Queues &amp; Assignment</div>
      <div class="hero-subtitle">
        Use this page during a shift to see which department queues are heaviest,
        which cases are still unassigned, and where the highest-priority work sits.
      </div>
      <div class="hero-meta">
        Queues use the same ML priority score as the Command Center. Start by picking
        a department below.
      </div>
    </div>

    <!-- Department selector block -->
    <div class="filters-card">
      <div class="filters-header">
        <div class="filters-title">Department queue</div>
        <div class="filters-hint">Choose a department to see its work queue.</div>
      </div>

      <!-- Simple GET form that reloads the page with ?department=... -->
      <form method="get" action="/work-queues" class="filters-row">
        <label for="department">Department</label>
        <select id="department" name="department">
          <option value="" {% if not sel_dept %}selected{% endif %}>Select a department…</option>
          {% for d in departments %}
            <option value="{{ d }}" {% if sel_dept == d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="btn">Show queue</button>
      </form>
    </div>

    {# If no department is selected, show a gentle hint #}
    {% if not sel_dept %}
      <div class="dept-header-card">
        <div class="dept-name">No department selected</div>
        <div class="dept-meta">
          Pick a department above to see its open cases, ordered by ML priority score.
        </div>
      </div>
    {% else %}
      <!-- Department summary header (name + counts) -->
      <div class="dept-header-card">
        <div class="dept-name">{{ sel_dept }}</div>
        {% if stats %}
          <div class="dept-meta">
            {{ stats.total_open }} open cases
            {% if stats.num_crit > 0 %} • {{ stats.num_crit }} critical{% endif %}
            {% if stats.avg_score %} • Avg priority score {{ stats.avg_score }}{% endif %}
          </div>
        {% else %}
          <div class="dept-meta">
            No open cases in this department for the current data.
          </div>
        {% endif %}
      </div>

      {# If there are no open cases in the chosen department #}
      {% if work_queue|length == 0 %}
        <div class="queue-list-card">
          <div class="empty-text queue-empty-inner">
            No open cases found for {{ sel_dept }}.
          </div>
        </div>
      {% else %}
        <!-- List of up to 100 open cases, sorted by ML priority score -->
        <div class="queue-list-card">
          {% for row in work_queue %}
            <div class="queue-item">
              <!-- Left column: case info and action buttons -->
              <div class="queue-main">
                <div class="queue-title">
                  <!-- Prototype anchor: we keep it on-page (#case-...) for now -->
                  <a href="#case-{{ row.case_enquiry_id }}">Case {{ row.case_enquiry_id }}</a>
                </div>
                <div class="queue-subline">
                  {{ row.neighborhood or "Unknown neighborhood" }}
                  {% if row.reason %} • {{ row.reason }}{% endif %}
                </div>

                <!-- Tags: segment, status, priority bucket -->
                <div class="queue-tags">
                  {% if row.segment %}
                    <span class="tag tag-segment">{{ row.segment }}</span>
                  {% endif %}
                  <span class="tag tag-status">Unassigned</span>

                  {% if row.priority_score is defined %}
                    {% if row.priority_score >= 0.9 %}
                      <span class="tag tag-priority-high">High priority</span>
                    {% elif row.priority_score >= 0.7 %}
                      <span class="tag tag-priority-med">Medium priority</span>
                    {% else %}
                      <span class="tag tag-priority-low">Lower priority</span>
                    {% endif %}
                  {% endif %}
                </div>

                <!-- Action buttons (currently prototype with JS alert) -->
                <div class="queue-buttons">
                  <button type="button" class="queue-btn queue-btn-primary queue-btn-action">
                    Assign to crew…
                  </button>
                  <button type="button" class="queue-btn queue-btn-action">
                    Mark in-progress
                  </button>
                  <button type="button" class="queue-btn queue-btn-action">
                    Add note
                  </button>
                </div>
              </div>

              <!-- Right column: numeric ML priority score -->
              <div class="queue-side">
                {% if row.priority_score is defined %}
                  <div class="queue-score">{{ "%.3f"|format(row.priority_score) }}</div>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endif %}

    {# Small note: we only show the top N cases to keep the page responsive #}
    {% if sel_dept and work_queue|length > 0 %}
      <div class="empty-text queue-footnote">
        Showing up to the top 100 cases by priority for {{ sel_dept }}.
      </div>
    {% endif %}
  </div>

  <!-- Page JS: applies dark mode and hooks up prototype button actions -->
  <script src="{{ url_for('static', filename='js/work_queues.js') }}" defer></script>
</body>
</html>