<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boston 311 – Analytics</title>

  <!-- Load Inter font for the dashboard UI -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Page-specific CSS for the Analytics tab -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/analytics.css') }}">

  <!-- Chart.js library for all the visualizations on this page -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- Top navigation bar shared across dashboard pages -->
  <div class="top-nav">
    <div class="top-nav-left">
      <!-- Small badge to show this is the City of Boston dashboard -->
      <div class="city-badge">City of Boston</div>
      <div class="top-nav-title">
        <div class="top-nav-title-main">311 Analytics</div>
        <div class="top-nav-title-sub">
          See which neighborhoods, departments, topics, and channels are driving 311 demand.
        </div>
      </div>
    </div>
    <div class="top-nav-right">
      <!-- Environment label so we remember this is not production -->
      <div class="env-pill">Environment: Internal • Pilot model v1.0</div>
      <!-- Simple system status indicator -->
      <div class="system-status-pill">
        <span class="status-dot"></span>
        System online
      </div>
    </div>
  </div>

  <!-- Main page container -->
  <div class="page-shell">
    <!-- Tabs to navigate between different dashboard views -->
    <div class="page-tabs">
      <a href="/" class="page-tab">Command Center</a>
      <a href="/work-queues" class="page-tab">Work Queues</a>
      <a href="/neighborhoods" class="page-tab">Neighborhood performance</a>
      <a href="/sla-performance" class="page-tab">SLA performance</a>
      <a href="/demand-trends" class="page-tab">Demand trends</a>
      <!-- Analytics tab is highlighted as the active view -->
      <a href="/analytics" class="page-tab page-tab-active">Analytics</a>
    </div>

    <!-- Hero section that explains what this page is used for -->
    <div class="hero-card">
      <div class="hero-main-title">Analytics</div>
      <div class="hero-subtitle">
        Focused on where 311 demand is coming from and how residents report issues.
        Use this for hyper-local planning, outreach campaigns, and source/channel optimization.
      </div>
      <div class="hero-meta">
        Data source: same 12-month 311 feed used by SLA and Demand Trends views.
      </div>
    </div>

    <!-- Row 1: neighborhood and department volume -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Cases by neighborhood (top 10)</div>
          <div class="chart-subtitle">
            Which neighborhoods generated the most 311 volume in the last year.
          </div>
        </div>
        {% if neigh_labels|length == 0 %}
          <!-- Fallback message when there is no neighborhood data -->
          <div class="chart-empty">No neighborhood data available.</div>
        {% else %}
          <!-- Canvas element where Chart.js will render the neighborhood bar chart -->
          <canvas id="neighCasesChart"></canvas>
        {% endif %}
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Cases by department (top 10)</div>
          <div class="chart-subtitle">
            Departments receiving the highest number of requests.
          </div>
        </div>
        {% if dept_labels|length == 0 %}
          <!-- Fallback message when there is no department data -->
          <div class="chart-empty">No department data available.</div>
        {% else %}
          <!-- Canvas for department cases chart -->
          <canvas id="deptCasesChart"></canvas>
        {% endif %}
      </div>
    </div>

    <!-- Row 2: top reasons and SLA performance -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Top request reasons (top 10)</div>
          <div class="chart-subtitle">
            Most common issue types citywide.
          </div>
        </div>
        {% if reason_labels|length == 0 %}
          <!-- Fallback message when there is no reason/topic data -->
          <div class="chart-empty">No topic data available.</div>
        {% else %}
          <!-- Canvas for top request reasons chart -->
          <canvas id="reasonCasesChart"></canvas>
        {% endif %}
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">SLA compliance by department</div>
          <div class="chart-subtitle">
            Percent of closed cases completed before their SLA deadline.
          </div>
        </div>
        {% if sla_dept_labels|length == 0 %}
          <!-- Fallback message when SLA data is not available -->
          <div class="chart-empty">No SLA data available.</div>
        {% else %}
          <!-- Canvas for SLA compliance chart -->
          <canvas id="slaDeptChart"></canvas>
        {% endif %}
      </div>
    </div>

    <!-- Row 3: source channel volume and resolution times -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Volume by report source</div>
          <div class="chart-subtitle">
            Share of cases by channel (Call, BOS311 app, Web, etc.).
          </div>
        </div>
        {% if src_labels|length == 0 %}
          <!-- Fallback message when there is no source/channel data -->
          <div class="chart-empty">No report source data available.</div>
        {% else %}
          <!-- Canvas for doughnut chart showing volume by source -->
          <canvas id="sourceVolumeChart"></canvas>
        {% endif %}
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Average resolution time by source</div>
          <div class="chart-subtitle">
            Mean hours from open to close for each reporting channel.
          </div>
        </div>
        {% if src_art_labels|length == 0 %}
          <!-- Fallback message when resolution-time data is missing -->
          <div class="chart-empty">No resolution-time data available.</div>
        {% else %}
          <!-- Canvas for bar chart of average resolution time by source -->
          <canvas id="sourceArtChart"></canvas>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Inline JSON data that the JS file will parse to build the charts -->
  <script id="analytics-data" type="application/json">
    {{
      {
        "neighLabels":   neigh_labels   or [],
        "neighCounts":   neigh_counts   or [],
        "deptLabels":    dept_labels    or [],
        "deptCounts":    dept_counts    or [],
        "reasonLabels":  reason_labels  or [],
        "reasonCounts":  reason_counts  or [],
        "slaDeptLabels": sla_dept_labels or [],
        "slaDeptRates":  sla_dept_rates  or [],
        "srcLabels":     src_labels     or [],
        "srcCounts":     src_counts     or [],
        "srcArtLabels":  src_art_labels or [],
        "srcArtHours":   src_art_hours  or []
      } | tojson | safe
    }}
  </script>

  <!-- Page-specific JavaScript that reads the JSON above and renders all charts -->
  <script src="{{ url_for('static', filename='js/analytics.js') }}" defer></script>
</body>
</html>
