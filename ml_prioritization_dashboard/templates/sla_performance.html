<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boston 311 SLA Performance & Compliance</title>

  <!-- Load the Inter font so this page matches the other dashboards -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet styles for the SLA map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Page-specific CSS for the SLA view -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/sla_performance.css') }}">
</head>
<body>

  <!-- Shared top nav with city branding and environment info -->
  <div class="top-nav">
    <div class="top-nav-left">
      <div class="city-badge">City of Boston</div>
      <div class="top-nav-title">
        <div class="top-nav-title-main">311 SLA Performance &amp; Compliance</div>
        <div class="top-nav-title-sub">
          Track SLA compliance, resolution times, and overdue cases across the city.
        </div>
      </div>
    </div>
    <div class="top-nav-right">
      <div class="env-pill">Environment: Internal â€¢ Pilot model v1.0</div>
      <div class="system-status-pill">
        <span class="status-dot"></span>
        System online
      </div>
    </div>
  </div>

  <div class="page-shell">
    <!-- Tabs that let staff jump between Command Center, SLA, Demand Trends, etc. -->
    <div class="page-tabs">
      <a href="/" class="page-tab">Command Center</a>
      <a href="/work-queues" class="page-tab">Work Queues</a>
      <a href="/neighborhoods" class="page-tab">Neighborhood performance</a>
      <a href="/sla-performance" class="page-tab page-tab-active">SLA performance</a>
      <a href="/demand-trends" class="page-tab">Demand trends</a>
      <a href="/analytics" class="page-tab">Analytics</a>
    </div>

    <!-- Hero card explaining what this SLA dashboard is meant for -->
    <div class="hero-card">
      <div>
        <div class="hero-main-title">SLA Performance &amp; Compliance</div>
        <div class="hero-subtitle">
          Use this view for accountability and planning. See how often teams beat SLA deadlines,
          which services take longest to close, and where overdue cases are clustered.
        </div>
        <div class="hero-meta">
          SLA metrics are based on the built-in target close dates and the same underlying 311 data
          as the Command Center.
        </div>
      </div>
      <div class="hero-side">
        <div>
          Good for weekly reviews, stand-ups, and performance check-ins with department leads.
        </div>
      </div>
    </div>

    <!-- Top-level KPIs summarizing SLA performance across the city -->
    <div class="kpi-strip">
      <div class="kpi-card">
        <div class="kpi-label">Overall SLA compliance</div>
        <div class="kpi-value">
          {{ "%.1f"|format(overall_sla_rate) if overall_sla_rate is not none else "â€”" }}%
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Avg resolution time (all cases)</div>
        <div class="kpi-value">
          {% if avg_resolution_days_all is not none and avg_resolution_hours_all is not none %}
            {{ "%.1f"|format(avg_resolution_days_all) }} days (~{{ "%.1f"|format(avg_resolution_hours_all) }} hrs)
          {% elif avg_resolution_hours_all is not none %}
            {{ "%.1f"|format(avg_resolution_hours_all) }} hrs
          {% else %}
            â€”
          {% endif %}
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Currently overdue &amp; still open</div>
        <div class="kpi-value">
          {{ overdue_count if overdue_count is not none else 0 }}
        </div>
      </div>
    </div>

    <!-- First row: overall SLA gauge and compliance by department -->
    <div class="charts-row">
      <!-- Half-gauge that shows overall SLA compliance % -->
      <div class="panel">
        <div class="panel-header-row">
          <div>
            <div class="panel-title">SLA compliance rate</div>
            <div class="panel-subtitle">
              Percentage of cases closed before their SLA target close date.
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="slaGaugeChart"></canvas>
        </div>
      </div>

      <!-- Horizontal bar chart comparing SLA compliance by department -->
      <div class="panel">
        <div class="panel-header-row">
          <div>
            <div class="panel-title">Compliance by department</div>
            <div class="panel-subtitle">
              Compare SLA performance across departments to spot leaders and laggards.
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="slaDeptBarChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Second row: average resolution time per service + overdue map -->
    <div class="charts-row">
      <!-- Bar chart of average resolution time per service in hours -->
      <div class="panel">
        <div class="panel-header-row">
          <div>
            <div class="panel-title">Average resolution time by service</div>
            <div class="panel-subtitle">
              Mean time from open to close for each service (in hours). Use this to understand where work lingers.
            </div>
          </div>
        </div>
        <div class="chart-container chart-tall">
          <canvas id="artServiceBarChart"></canvas>
        </div>
      </div>

      <!-- Leaflet map showing the location of overdue open cases -->
      <div class="panel">
        <div class="panel-header-row">
          <div>
            <div class="panel-title">Overdue cases on the map</div>
            <div class="panel-subtitle">
              Each marker is an open case whose SLA deadline has passed.
            </div>
          </div>
        </div>
        <div class="chart-container chart-tall">
          <div id="slaMap"></div>
        </div>
      </div>
    </div>

    <!-- Drilldown table: list of overdue cases with a neighborhood filter -->
    <div class="panel">
      <div class="panel-header-row">
        <div>
          <div class="panel-title">Overdue cases drilldown</div>
          <div class="panel-subtitle">
            Open cases whose SLA deadline has passed. Filter by neighborhood to focus a field team.
          </div>
        </div>
      </div>

      <!-- Simple dropdown that will filter both the table and the map via JS -->
      <div class="filter-row">
        <label for="overdueNeighborhoodFilter">Neighborhood</label>
        <select id="overdueNeighborhoodFilter">
          <option value="ALL" selected>All neighborhoods</option>
          {% if overdue_neighborhoods %}
            {% for n in overdue_neighborhoods %}
              <option value="{{ n }}">{{ n }}</option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      {% if overdue_cases|length == 0 %}
        <!-- Friendly message when there are no overdue cases at all -->
        <p class="empty-text">No overdue open cases at the moment. ðŸŽ‰</p>
      {% else %}
        <!-- Scrollable table listing each overdue case and its neighborhood/department/status -->
        <div class="overdue-table-wrapper">
          <table id="overdueTable">
            <thead>
              <tr>
                <th>Case ID</th>
                <th>Neighborhood</th>
                <th>Department</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for row in overdue_cases %}
                <tr data-neighborhood="{{ row.neighborhood or 'Unknown' }}">
                  <td>Case {{ row.case_enquiry_id }}</td>
                  <td>{{ row.neighborhood or "Unknown" }}</td>
                  <td>{{ row.department or "Unknown" }}</td>
                  <td><span class="tag-overdue">{{ row.case_status or "OVERDUE" }}</span></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Vendor libraries: Chart.js for charts and Leaflet for the overdue map -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- Inline JSON block that passes SLA metrics and map data into the JS file -->
  <script id="sla-data" type="application/json">
    {{
      {
        "overallSlaRate": overall_sla_rate or 0,
        "deptLabels": sla_dept_labels or [],
        "deptRates": sla_dept_rates or [],
        "artServiceLabels": art_service_labels or [],
        "artServiceHours": art_service_hours or [],
        "overdueMapCases": overdue_map_cases or []
      } | tojson | safe
    }}
  </script>

  <!-- Page-specific JS that renders charts and hooks up the map + filter -->
  <script src="{{ url_for('static', filename='js/sla_performance.js') }}" defer></script>
</body>
</html>