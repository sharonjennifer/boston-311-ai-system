<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boston 311 Priority Command Center</title>

  <!-- Load Inter font for a clean, modern UI -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  >

  <!-- Main CSS for the command center dashboard -->
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/dashboard.css', v='1.0.0') }}"
  />

  <!-- Leaflet CSS so we can render the 311 map -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
</head>
<body>

  <!-- Top city bar that makes this feel like an official Boston tool -->
  <div class="top-nav">
    <div class="top-nav-left">
      <!-- Small badge that labels the city -->
      <div class="city-badge">City of Boston</div>
      <div class="top-nav-title">
        <div class="top-nav-title-main">311 Priority Command Center</div>
        <div class="top-nav-title-sub">
          Internal view for supervisors, dispatchers, and crews to triage Boston 311 requests.
        </div>
      </div>
    </div>
    <div class="top-nav-right">
      <!-- Environment indicator so we know this is an internal pilot, not production -->
      <div class="env-pill">Environment: Internal • Pilot model v1.0</div>
      <!-- Simple uptime indicator -->
      <div class="system-status-pill">
        <span class="status-dot"></span>
        System online
      </div>
    </div>
  </div>

  <!-- Darkened overlay and tooltip used for the guided tour steps -->
  <div id="tourOverlay" class="tour-overlay"></div>
  <div id="tourTooltip" class="tour-tooltip"></div>

  <!-- Main page layout wrapper -->
  <div class="page-shell">

    <!-- Navigation tabs to jump between different dashboard sections -->
    <div class="page-tabs">
      <a href="/" class="page-tab page-tab-active">Command Center</a>
      <a href="/work-queues" class="page-tab">Work Queues</a>
      <a href="/neighborhoods" class="page-tab">Neighborhood performance</a>
      <a href="/sla-performance" class="page-tab">SLA performance</a>
      <a href="/demand-trends" class="page-tab">Demand trends</a>
      <a href="/analytics" class="page-tab">Analytics</a>
    </div>

    <!-- Hero section that explains what this view is for and which model powers it -->
    <div class="hero-card" id="heroCard">
      <div class="hero-main">
        <div class="hero-title">Boston 311 Priority Workboard</div>
        <div class="hero-subtitle">
          Live view of open 311 cases, ranked by an ML-based priority score. Use this page as
          your daily command center to understand workload, hot spots, and the top cases to act on.
        </div>
        <div class="hero-meta-row">
          <!-- First pill: short description of the model -->
          <div class="hero-meta-pill">
            <span class="hero-meta-dot"></span>
            ML model: XGBoost priority scorer
          </div>
          <!-- Second pill: note that we applied bias mitigation -->
          <div class="hero-meta-pill">
            <span class="hero-meta-dot" style="background:#f97316;"></span>
            Bias mitigation: neighborhood &amp; department re-weighting
          </div>
        </div>
      </div>

      <!-- Right side of hero shows data freshness and quick actions -->
      <div class="hero-side">
        <div class="hero-side-label">Data freshness</div>
        <div class="hero-last-updated">
          <span style="width:7px;height:7px;border-radius:999px;background:#22c55e;"></span>
          <!-- We show a human-readable label if available, otherwise default to "Today" -->
          Last training run: {{ stats.last_run_label if stats.last_run_label is defined else "Today" }}
        </div>
        <div class="hero-side-label" style="margin-top:6px;">Quick actions</div>
        <div class="toggle-group">
          <!-- Button that toggles dark mode for this dashboard -->
          <button type="button" id="darkModeToggle" class="btn-secondary">Toggle dark mode</button>
          <!-- Button to restart the guided explanation of the page -->
          <button type="button" id="tourRestartBtn" class="btn-secondary">Replay tour</button>
        </div>
      </div>
    </div>

    <!-- Filter panel where users slice the 311 data before viewing KPIs, map, and list -->
    <div class="filters-card" id="filtersCard">
      <div class="filters-header">
        <div class="filters-title">Filters</div>
        <div class="filters-hint">
          Tune your slice of the city, then apply to refresh KPIs, map, and queue.
        </div>
      </div>

      <!-- We submit filters via GET so URLs can be bookmarked/shared with the same view -->
      <form id="filterForm" method="get" action="/" class="filters-form-row">
        <!-- Neighborhood dropdown -->
        <div>
          <label for="neighborhood">Neighborhood</label>
          <select id="neighborhood" name="neighborhood">
            <option value="ALL" {% if sel_neigh == 'ALL' %}selected{% endif %}>All</option>
            {% for n in neighborhoods %}
              <option value="{{ n }}" {% if sel_neigh == n %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Reason dropdown -->
        <div>
          <label for="reason">Reason</label>
          <select id="reason" name="reason">
            <option value="ALL" {% if sel_reason == 'ALL' %}selected{% endif %}>All</option>
            {% for r in reasons %}
              <option value="{{ r }}" {% if sel_reason == r %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Department dropdown -->
        <div>
          <label for="department">Department</label>
          <select id="department" name="department">
            <option value="ALL" {% if sel_dept == 'ALL' %}selected{% endif %}>All</option>
            {% for d in departments %}
              <option value="{{ d }}" {% if sel_dept == d %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Case ID filter for looking up a specific ticket -->
        <div>
          <label for="case_id">Case ID</label>
          <input
            type="text"
            id="case_id"
            name="case_id"
            placeholder="e.g. 1010..."
            value="{{ sel_case or '' }}"
          />
        </div>

        <!-- Hidden fields that hold the “What’s Near Me?” location info -->
        <input type="hidden" id="near_lat" name="near_lat" value="{{ near_lat or '' }}">
        <input type="hidden" id="near_lon" name="near_lon" value="{{ near_lon or '' }}">
        <input type="hidden" id="near_radius_m" name="near_radius_m" value="{{ near_radius_m or '' }}">

        <!-- Main filter submit button -->
        <button type="submit" class="btn">Apply filters</button>
        <!-- Button that triggers geolocation and sets the near-me fields -->
        <button type="button" id="nearMeBtn" class="btn-outline">What’s Near Me?</button>

        <!-- Space where we show messages if geolocation fails -->
        <span id="nearMeMessage" class="nearme-msg"></span>
      </form>
    </div>

    <!-- KPI cards summarizing the current filtered slice -->
    <div class="kpi-strip" id="kpiRow">
      <div class="kpi-card">
        <div class="kpi-label">Total open cases (filtered)</div>
        <div class="kpi-value-row">
          <div class="kpi-value">{{ stats.total_open }}</div>
        </div>
      </div>
      <div class="kpi-card kpi-critical">
        <div class="kpi-label">Critical cases (filtered)</div>
        <div class="kpi-value-row">
          <div class="kpi-value">{{ stats.num_crit }}</div>
          <div class="kpi-pill">ML-marked critical</div>
        </div>
      </div>
      <div class="kpi-card kpi-share">
        <div class="kpi-label">Critical share</div>
        <div class="kpi-value-row">
          <div class="kpi-value">{{ stats.crit_share }}%</div>
        </div>
      </div>
    </div>

    <!-- Map panel that shows the spatial distribution of the filtered open cases -->
    <div class="panel" id="mapPanel">
      <div class="panel-header">
        <div class="panel-title">Map of filtered cases</div>
        <div class="panel-subtitle">
          Each circle is an open case, sized and colored by priority.
        </div>
      </div>
      <!-- Leaflet injects its map tiles into this div -->
      <div id="map"></div>
    </div>

    <!-- Case list panel: top 10 priority-ordered cases for the current filters -->
    <div class="panel cases-panel">
      <div class="section-heading-row">
        <div>
          <div class="section-heading">Top 10 cases – current filters</div>
          <div class="section-subtitle">
            Ordered by ML priority score, highest first. Treat this as the “first look” queue while you refine.
          </div>
        </div>
      </div>

      {% if critical_cases|length == 0 %}
        <!-- If nothing matches the filters, we show a friendly no-data message -->
        <div class="no-cases-text">No cases found for the selected filters.</div>
      {% else %}
        <!-- Scrollable list of case cards populated from the BigQuery results -->
        <div class="case-list" id="caseListMain">
          {% for row in critical_cases %}
            <!-- We add a priority class based on the numeric score to color the border -->
            <div class="case-card
                        {% if row.priority_score is defined %}
                          {% if row.priority_score >= 0.9 %} priority-high
                          {% elif row.priority_score >= 0.7 %} priority-med
                          {% else %} priority-low
                          {% endif %}
                        {% endif %}">
              <!-- Rank within the filtered list (1 = highest priority) -->
              <div class="case-rank">#{{ row.rank_overall }}</div>

              <!-- Main case details: ID, neighborhood, reason, department, etc. -->
              <div class="case-main">
                <div class="case-title-line">
                  <span class="case-id">Case {{ row.case_enquiry_id }}</span>
                  {% if row.neighborhood %}
                    • <span class="case-neighborhood">{{ row.neighborhood }}</span>
                  {% endif %}
                </div>

                <!-- Badges add quick visual labels for reason, department, and segment -->
                <div class="case-badges">
                  {% if row.reason %}
                    <span class="badge badge-reason">{{ row.reason }}</span>
                  {% endif %}
                  {% if row.department %}
                    <span class="badge badge-dept">Dept: {{ row.department }}</span>
                  {% endif %}
                  {% if row.segment %}
                    <span class="badge badge-segment">{{ row.segment }}</span>
                  {% endif %}
                </div>

                <!-- Extra context such as repeat reports and nearby open cases -->
                <div class="case-sub">
                  {% if row.prev_repeat_90d_30m is defined %}
                    <span>
                      Past reports nearby: {{ row.prev_repeat_90d_30m }}
                    </span>
                  {% endif %}
                  {% if row.neigh_open_14d is defined and row.neigh_open_14d > 0 %}
                    <span>
                      Open cases nearby (14 days): {{ row.neigh_open_14d }}
                    </span>
                  {% endif %}
                </div>
              </div>

              <!-- Right side shows the numeric ML priority score and a progress bar -->
              <div class="case-score">
                <div class="case-score-label">Priority score</div>
                <div class="case-score-value">
                  {{ "%.3f"|format(row.priority_score) }}
                </div>
                <div class="case-score-bar">
                  <div class="case-score-bar-fill"
                       style="width: {{ (row.priority_score * 100)|round(0) }}%;"></div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- JS libraries and data injection -->

  <!-- Leaflet JS to power the interactive map -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- Expose the combos and map cases into a global object for dashboard.js to use -->
  <script>
    window.B311_DATA = {
      combos: {{ combos | tojson | safe }},
      mapCases: {{ map_cases | tojson | safe }}
    };
  </script>

  <!-- Main JavaScript for this Command Center page -->
  <script
    src="{{ url_for('static', filename='js/dashboard.js', v='1.0.0') }}"
    defer
  ></script>
</body>
</html>