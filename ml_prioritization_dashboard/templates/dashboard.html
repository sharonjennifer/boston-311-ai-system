<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boston 311 Priority Command Center</title>

  <!-- Modern font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Layout + background */
      --bg-shell: #f5f7fb;
      --bg-main: #f5f7fb;
      --bg-card: #ffffff;
      --bg-card-soft: #f8fafc;
      --border-subtle: #e2e8f0;

      /* Brand-ish palette (navy + red like your refs) */
      --nav-bg: #021b3b;
      --nav-bg-alt: #0b2648;
      --nav-border: #0f2f5f;

      --accent-blue: #2563eb;
      --accent-blue-soft: #dbeafe;
      --accent-red: #ff4c4c;
      --accent-red-soft: #ffe3e3;
      --accent-orange: #f97316;

      --text-main: #0f172a;
      --text-muted: #6b7280;

      /* Priority colors */
      --prio-high: #b91c1c;
      --prio-med: #f97316;
      --prio-low: #16a34a;
    }

    body.dark-mode {
      --bg-shell: #020617;
      --bg-main: #020617;
      --bg-card: #02081f;
      --bg-card-soft: #020617;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-shell);
      color: var(--text-main);
    }

    /* ----------------- TOP NAV (CITY BAR) ----------------- */

    .top-nav {
      background: linear-gradient(90deg, var(--nav-bg), var(--nav-bg-alt));
      border-bottom: 1px solid var(--nav-border);
      color: #f9fafb;
      padding: 10px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .top-nav-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .city-badge {
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.6);
      padding: 4px 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 600;
    }

    .top-nav-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .top-nav-title-main {
      font-size: 20px;
      font-weight: 600;
    }

    .top-nav-title-sub {
      font-size: 12px;
      opacity: 0.85;
    }

    .top-nav-right {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
    }

    .system-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(34,197,94,0.05);
      border: 1px solid rgba(34,197,94,0.3);
      color: #bbf7d0;
      font-weight: 500;
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34,197,94,0.35);
    }

    .env-pill {
      border-radius: 999px;
      padding: 3px 10px;
      border: 1px solid rgba(148,163,184,0.5);
      color: #e5e7eb;
      background: rgba(15,23,42,0.4);
    }

    /* ----------------- PAGE SHELL ----------------- */

    .page-shell {
      padding: 20px 32px 40px;
    }

    @media (max-width: 768px) {
      .top-nav, .page-shell {
        padding-inline: 16px;
      }
    }

    /* Tabs between Command Center / Work Queues */
    .page-tabs {
      margin-bottom: 10px;
      display: inline-flex;
      border-radius: 999px;
      background: #e5e7eb;
      padding: 2px;
      gap: 2px;
    }

    .page-tab {
      padding: 5px 12px;
      font-size: 11px;
      border-radius: 999px;
      text-decoration: none;
      color: #374151;
      font-weight: 500;
    }

    .page-tab-active {
      background: #ffffff;
      color: #111827;
    }

    .hero-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 18px 20px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.08);
      border: 1px solid var(--border-subtle);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .hero-main {
      max-width: 680px;
    }

    .hero-title {
      font-size: 24px;
      font-weight: 650;
      margin-bottom: 6px;
    }

    .hero-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      max-width: 560px;
    }

    .hero-meta-row {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .hero-meta-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
    }

    .hero-meta-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #1d4ed8;
    }

    .hero-side {
      min-width: 220px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .hero-side-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
    }

    .hero-last-updated {
      padding: 5px 10px;
      border-radius: 999px;
      background: var(--bg-card-soft);
      border: 1px solid var(--border-subtle);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    /* ----------------- FILTERS BAR ----------------- */

    .filters-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 10px 14px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 14px;
      box-shadow: 0 6px 18px rgba(15,23,42,0.05);
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      gap: 10px;
    }

    .filters-title {
      font-size: 13px;
      font-weight: 600;
    }

    .filters-hint {
      font-size: 11px;
      color: var(--text-muted);
    }

    .filters-form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-top: 4px;
    }

    label {
      font-size: 12px;
      font-weight: 600;
      margin-right: 3px;
    }

    select, input[type="text"] {
      padding: 5px 8px;
      border-radius: 7px;
      border: 1px solid #cbd5e1;
      background: #f9fafb;
      font-size: 12px;
      min-width: 140px;
    }

    select:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.3);
      background: #ffffff;
    }

    .btn,
    .btn-secondary,
    .btn-outline {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn {
      background: linear-gradient(135deg, var(--accent-blue), #3b82f6);
      color: white;
      box-shadow: 0 4px 12px rgba(37,99,235,0.36);
    }

    .btn-outline {
      background: #ffffff;
      color: var(--accent-blue);
      border: 1px solid rgba(37,99,235,0.7);
    }

    .btn-secondary {
      background: var(--bg-card-soft);
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
    }

    .btn:disabled,
    .btn-outline:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
    }

    .nearme-msg {
      font-size: 11px;
      color: var(--accent-red);
      min-height: 14px;
    }

    /* ----------------- KPI STRIP ----------------- */

    .kpi-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-bottom: 16px;
    }

    .kpi-card {
      flex: 1;
      min-width: 170px;
      background: var(--bg-card);
      border-radius: 12px;
      padding: 10px 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 6px 18px rgba(15,23,42,0.05);
    }

    .kpi-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.7px;
      color: var(--text-muted);
    }

    .kpi-value-row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-top: 6px;
    }

    .kpi-value {
      font-size: 26px;
      font-weight: 700;
    }

    .kpi-pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--accent-red-soft);
      color: #b91c1c;
      font-weight: 500;
    }

    .kpi-critical .kpi-value {
      color: var(--accent-red);
    }

    .kpi-share .kpi-value {
      color: var(--accent-orange);
    }

    /* ----------------- MAP PANEL ----------------- */

    .panel {
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 6px 18px rgba(15,23,42,0.05);
      padding: 12px 14px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 600;
    }

    .panel-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    #map {
      height: 430px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #e5e7eb;
    }

    /* ----------------- CASE LIST ----------------- */

    .cases-panel {
      margin-top: 18px;
    }

    .section-heading-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .section-heading {
      font-size: 16px;
      font-weight: 600;
    }

    .section-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .case-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .case-card {
      display: flex;
      align-items: stretch;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      box-shadow: 0 2px 6px rgba(15,23,42,0.06);
      font-size: 12px;
    }

    .case-card.priority-high {
      border-left: 4px solid var(--prio-high);
    }

    .case-card.priority-med {
      border-left: 4px solid var(--prio-med);
    }

    .case-card.priority-low {
      border-left: 4px solid var(--prio-low);
    }

    .case-rank {
      min-width: 36px;
      font-size: 18px;
      font-weight: 600;
      color: #4b5563;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .case-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .case-title-line {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: baseline;
    }

    .case-id {
      color: var(--accent-blue);
    }

    .case-neighborhood {
      color: #4b5563;
      font-weight: 500;
    }

    .case-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
    }

    .badge-reason {
      background: #fef3c7;
      border-color: #fde68a;
      color: #92400e;
    }

    .badge-dept {
      background: #e0f2fe;
      border-color: #bae6fd;
      color: #075985;
    }

    .badge-segment {
      background: var(--accent-red-soft);
      border-color: #fecaca;
      color: #b91c1c;
    }

    .case-sub {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
      color: var(--text-muted);
      font-size: 11px;
    }

    .case-score {
      min-width: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
      text-align: right;
    }

    .case-score-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-muted);
    }

    .case-score-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent-red);
    }

    .case-score-bar {
      position: relative;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .case-score-bar-fill {
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent-red), #fb923c);
    }

    .no-cases-text {
      font-size: 12px;
      color: var(--text-muted);
      padding: 8px 0;
    }

    /* ----------------- TOUR OVERLAY ----------------- */

    .tour-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      z-index: 9998;
      display: none;
    }

    .tour-highlight {
      position: relative;
      z-index: 9999;
      box-shadow: 0 0 0 3px var(--accent-blue), 0 0 18px rgba(15,23,42,0.8);
    }

    .tour-tooltip {
      position: fixed;
      max-width: 320px;
      background: #ffffff;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.45);
      z-index: 10000;
      font-size: 12px;
      display: none;
    }

    .tour-tooltip-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .tour-tooltip-body {
      margin-bottom: 8px;
    }

    .tour-tooltip-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .tour-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 11px;
    }

    .tour-btn-primary {
      background: var(--accent-blue);
      color: #ffffff;
    }

    .tour-btn-secondary {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      color: #111827;
    }

    /* Intro modal (if you bring it back later) */
  </style>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
</head>
<body>

  <!-- Top city bar -->
  <div class="top-nav">
    <div class="top-nav-left">
      <div class="city-badge">City of Boston</div>
      <div class="top-nav-title">
        <div class="top-nav-title-main">311 Priority Command Center</div>
        <div class="top-nav-title-sub">
          Internal view for supervisors, dispatchers, and crews to triage Boston 311 requests.
        </div>
      </div>
    </div>
    <div class="top-nav-right">
      <div class="env-pill">Environment: Internal • Pilot model v1.0</div>
      <div class="system-status-pill">
        <span class="status-dot"></span>
        System online
      </div>
    </div>
  </div>

  <!-- Tour overlay + tooltip -->
  <div id="tourOverlay" class="tour-overlay"></div>
  <div id="tourTooltip" class="tour-tooltip"></div>

  <div class="page-shell">

    <div class="page-tabs">
      <a href="/" class="page-tab page-tab-active">Command Center</a>
      <a href="/work-queues" class="page-tab">Work Queues</a>
      <a href="/neighborhoods" class="page-tab">Neighborhood performance</a>
      <a href="/sla-performance" class="page-tab">SLA performance</a>
      <a href="/demand-trends" class="page-tab">Demand trends</a>
      <a href="/analytics" class="page-tab page-tab-active">Analytics</a>
    </div>

    <!-- HERO -->
    <div class="hero-card" id="heroCard">
      <div class="hero-main">
        <div class="hero-title">Boston 311 Priority Workboard</div>
        <div class="hero-subtitle">
          Live view of open 311 cases, ranked by an ML-based priority score. Use this page as
          your daily command center to understand workload, hot spots, and the top cases to act on.
        </div>
        <div class="hero-meta-row">
          <div class="hero-meta-pill">
            <span class="hero-meta-dot"></span>
            ML model: XGBoost priority scorer
          </div>
          <div class="hero-meta-pill">
            <span class="hero-meta-dot" style="background:#f97316;"></span>
            Bias mitigation: neighborhood &amp; department re-weighting
          </div>
        </div>
      </div>
      <div class="hero-side">
        <div class="hero-side-label">Data freshness</div>
        <div class="hero-last-updated">
          <span style="width:7px;height:7px;border-radius:999px;background:#22c55e;"></span>
          Last training run: {{ stats.last_run_label if stats.last_run_label is defined else "Today" }}
        </div>
        <div class="hero-side-label" style="margin-top:6px;">Quick actions</div>
        <div class="toggle-group">
          <button type="button" id="darkModeToggle" class="btn-secondary">Toggle dark mode</button>
          <button type="button" id="tourRestartBtn" class="btn-secondary">Replay tour</button>
        </div>
      </div>
    </div>

    <!-- FILTERS -->
    <div class="filters-card" id="filtersCard">
      <div class="filters-header">
        <div class="filters-title">Filters</div>
        <div class="filters-hint">Tune your slice of the city, then apply to refresh KPIs, map, and queue.</div>
      </div>
      <form id="filterForm" method="get" action="/" class="filters-form-row">
        <div>
          <label for="neighborhood">Neighborhood</label>
          <select id="neighborhood" name="neighborhood">
            <option value="ALL" {% if sel_neigh == 'ALL' %}selected{% endif %}>All</option>
            {% for n in neighborhoods %}
              <option value="{{ n }}" {% if sel_neigh == n %}selected{% endif %}>{{ n }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="reason">Reason</label>
          <select id="reason" name="reason">
            <option value="ALL" {% if sel_reason == 'ALL' %}selected{% endif %}>All</option>
            {% for r in reasons %}
              <option value="{{ r }}" {% if sel_reason == r %}selected{% endif %}>{{ r }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="department">Department</label>
          <select id="department" name="department">
            <option value="ALL" {% if sel_dept == 'ALL' %}selected{% endif %}>All</option>
            {% for d in departments %}
              <option value="{{ d }}" {% if sel_dept == d %}selected{% endif %}>{{ d }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="case_id">Case ID</label>
          <input
            type="text"
            id="case_id"
            name="case_id"
            placeholder="e.g. 1010..."
            value="{{ sel_case or '' }}"
          />
        </div>

        <!-- Hidden Near-Me fields -->
        <input type="hidden" id="near_lat" name="near_lat" value="{{ near_lat or '' }}">
        <input type="hidden" id="near_lon" name="near_lon" value="{{ near_lon or '' }}">
        <input type="hidden" id="near_radius_m" name="near_radius_m" value="{{ near_radius_m or '' }}">

        <button type="submit" class="btn">Apply filters</button>
        <button type="button" id="nearMeBtn" class="btn-outline">What’s Near Me?</button>

        <span id="nearMeMessage" class="nearme-msg"></span>
      </form>
    </div>

    <!-- KPI STRIP -->
    <div class="kpi-strip" id="kpiRow">
      <div class="kpi-card">
        <div class="kpi-label">Total open cases (filtered)</div>
        <div class="kpi-value-row">
          <div class="kpi-value">{{ stats.total_open }}</div>
        </div>
      </div>
      <div class="kpi-card kpi-critical">
        <div class="kpi-label">Critical cases (filtered)</div>
        <div class="kpi-value-row">
          <div class="kpi-value">{{ stats.num_crit }}</div>
          <div class="kpi-pill">ML-marked critical</div>
        </div>
      </div>
      <div class="kpi-card kpi-share">
        <div class="kpi-label">Critical share</div>
        <div class="kpi-value-row">
          <div class="kpi-value">{{ stats.crit_share }}%</div>
        </div>
      </div>
    </div>

    <!-- MAP PANEL ONLY -->
    <div class="panel" id="mapPanel">
      <div class="panel-header">
        <div class="panel-title">Map of filtered cases</div>
        <div class="panel-subtitle">Each circle is an open case, sized and colored by priority.</div>
      </div>
      <div id="map"></div>
    </div>

    <!-- CASE LIST -->
    <div class="panel cases-panel">
      <div class="section-heading-row">
        <div>
          <div class="section-heading">Top 10 cases – current filters</div>
          <div class="section-subtitle">
            Ordered by ML priority score, highest first. Treat this as the “first look” queue while you refine.
          </div>
        </div>
      </div>

      {% if critical_cases|length == 0 %}
        <div class="no-cases-text">No cases found for the selected filters.</div>
      {% else %}
        <div class="case-list" id="caseListMain">
          {% for row in critical_cases %}
            <div class="case-card
                        {% if row.priority_score is defined %}
                          {% if row.priority_score >= 0.9 %} priority-high
                          {% elif row.priority_score >= 0.7 %} priority-med
                          {% else %} priority-low
                          {% endif %}
                        {% endif %}">
              <div class="case-rank">#{{ row.rank_overall }}</div>

              <div class="case-main">
                <div class="case-title-line">
                  <span class="case-id">Case {{ row.case_enquiry_id }}</span>
                  {% if row.neighborhood %}
                    • <span class="case-neighborhood">{{ row.neighborhood }}</span>
                  {% endif %}
                </div>

                <div class="case-badges">
                  {% if row.reason %}
                    <span class="badge badge-reason">{{ row.reason }}</span>
                  {% endif %}
                  {% if row.department %}
                    <span class="badge badge-dept">Dept: {{ row.department }}</span>
                  {% endif %}
                  {% if row.segment %}
                    <span class="badge badge-segment">{{ row.segment }}</span>
                  {% endif %}
                </div>

                <div class="case-sub">
                  {% if row.prev_repeat_90d_30m is defined %}
                    <span>
                      Past reports nearby: {{ row.prev_repeat_90d_30m }}
                    </span>
                  {% endif %}
                  {% if row.neigh_open_14d is defined and row.neigh_open_14d > 0 %}
                    <span>
                      Open cases nearby (14 days): {{ row.neigh_open_14d }}
                    </span>
                  {% endif %}
                </div>
              </div>

              <div class="case-score">
                <div class="case-score-label">Priority score</div>
                <div class="case-score-value">
                  {{ "%.3f"|format(row.priority_score) }}
                </div>
                <div class="case-score-bar">
                  <div class="case-score-bar-fill"
                       style="width: {{ (row.priority_score * 100)|round(0) }}%;"></div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- JS LIBS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /* ---------- Dark mode ---------- */
    function applyDarkFromStorage() {
      if (localStorage.getItem("b311_dark") === "true") {
        document.body.classList.add("dark-mode");
      }
    }
    applyDarkFromStorage();

    const darkModeToggle = document.getElementById("darkModeToggle");
    if (darkModeToggle) {
      darkModeToggle.addEventListener("click", () => {
        document.body.classList.toggle("dark-mode");
        const enabled = document.body.classList.contains("dark-mode");
        localStorage.setItem("b311_dark", enabled ? "true" : "false");
      });
    }

    /* ---------- What’s Near Me ---------- */
    const nearMeBtn     = document.getElementById("nearMeBtn");
    const filterForm    = document.getElementById("filterForm");
    const nearLat       = document.getElementById("near_lat");
    const nearLon       = document.getElementById("near_lon");
    const nearRadiusM   = document.getElementById("near_radius_m");
    const nearMeMessage = document.getElementById("nearMeMessage");

    if (nearMeBtn && navigator.geolocation) {
      nearMeBtn.addEventListener("click", () => {
        nearMeBtn.disabled = true;
        nearMeBtn.textContent = "Locating…";
        if (nearMeMessage) nearMeMessage.textContent = "";

        navigator.geolocation.getCurrentPosition(
          pos => {
            const { latitude, longitude } = pos.coords;
            nearLat.value = latitude.toString();
            nearLon.value = longitude.toString();
            nearRadiusM.value = "402"; // ~0.25 miles
            filterForm.submit();
          },
          err => {
            if (nearMeMessage) {
              nearMeMessage.textContent =
                err.code === err.PERMISSION_DENIED
                  ? "Location access blocked. Allow it in browser settings and try again."
                  : "Could not get your location. Please try again.";
            }
            nearMeBtn.disabled = false;
            nearMeBtn.textContent = "What’s Near Me?";
          }
        );
      });
    } else if (nearMeMessage && !navigator.geolocation) {
      nearMeMessage.textContent = "Geolocation not supported in this browser.";
    }

    // Clear near-me if filters change
    ["neighborhood","reason","department"].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener("change", () => {
        nearLat.value = "";
        nearLon.value = "";
        nearRadiusM.value = "";
      });
    });

    /* ---------- Cascading dropdowns using combos ---------- */
    const combos = {{ combos | tojson | safe }};
    const neighSelect = document.getElementById("neighborhood");
    const reasonSelect = document.getElementById("reason");
    const deptSelect = document.getElementById("department");

    function computeOptions(selNeigh, selReason) {
      const reasonSet = new Set();
      const deptSet = new Set();

      combos.forEach(row => {
        const n = row.neighborhood;
        const r = row.reason;
        const d = row.department;

        if (selNeigh === "ALL" || n === selNeigh) {
          reasonSet.add(r);
        }

        const neighOK = (selNeigh === "ALL" || n === selNeigh);
        const reasonOK = (selReason === "ALL" || r === selReason);
        if (neighOK && reasonOK) {
          deptSet.add(d);
        }
      });

      return {
        reasons: Array.from(reasonSet).sort(),
        departments: Array.from(deptSet).sort()
      };
    }

    function repopulate(selectElem, values, selectedValue) {
      selectElem.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value = "ALL";
      optAll.textContent = "All";
      selectElem.appendChild(optAll);

      values.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectElem.appendChild(opt);
      });

      if (selectedValue && selectedValue !== "ALL" && values.includes(selectedValue)) {
        selectElem.value = selectedValue;
      } else {
        selectElem.value = "ALL";
      }
    }

    function handleFilterChange() {
      const selNeigh = neighSelect.value;
      const selReason = reasonSelect.value;
      const selDept = deptSelect.value;

      const opts = computeOptions(selNeigh, selReason);
      const newReasonSelected = opts.reasons.includes(selReason) ? selReason : "ALL";
      const newDeptSelected = opts.departments.includes(selDept) ? selDept : "ALL";

      repopulate(reasonSelect, opts.reasons, newReasonSelected);
      repopulate(deptSelect, opts.departments, newDeptSelected);

      nearLat.value = "";
      nearLon.value = "";
      nearRadiusM.value = "";
    }

    if (neighSelect && reasonSelect && deptSelect) {
      neighSelect.addEventListener("change", handleFilterChange);
      reasonSelect.addEventListener("change", handleFilterChange);
      handleFilterChange();
    }

    /* ---------- MAP ---------- */
    const mapCases = {{ map_cases | tojson | safe }};
    if (mapCases.length > 0) {
      const map = L.map("map").setView([42.36, -71.06], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      const bounds = [];
      mapCases.forEach(c => {
        if (c.latitude == null || c.longitude == null) return;

        const lat = parseFloat(c.latitude);
        const lon = parseFloat(c.longitude);
        if (Number.isNaN(lat) || Number.isNaN(lon)) return;

        let baseRadius = 5;
        if (typeof c.priority_score === "number") {
          baseRadius = 4 + Math.min(6, c.priority_score * 8);
        }

        const marker = L.circleMarker([lat, lon], {
          radius: baseRadius,
          color: "#1f2937",
          weight: 1,
          fillColor: "#ff4c4c",
          fillOpacity: 0.85
        }).addTo(map);

        marker.bindPopup(
          `<b>Case ${c.case_enquiry_id}</b><br/>
           ${c.neighborhood || ""}<br/>
           ${c.reason || ""}<br/>
           Dept: ${c.department || ""}<br/>
           Score: ${
             (typeof c.priority_score === "number")
               ? c.priority_score.toFixed(3)
               : c.priority_score
           }`
        );

        bounds.push([lat, lon]);
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [20, 20] });
      }
    } else {
      document.getElementById("map").innerHTML =
        '<p style="font-size:12px;color:#6b7280;padding:8px;">No map cases for current filters.</p>';
    }

    /* ---------- Guided tour (shortened, no charts step) ---------- */
    const tourOverlay   = document.getElementById("tourOverlay");
    const tourTooltip   = document.getElementById("tourTooltip");

    const filtersCard   = document.getElementById("filtersCard");
    const kpiRow        = document.getElementById("kpiRow");
    const mapPanel      = document.getElementById("mapPanel");
    const caseListMain  = document.getElementById("caseListMain");
    const tourRestart   = document.getElementById("tourRestartBtn");

    let tourIndex = 0;

    const tourSteps = [
      {
        title: "Filters",
        text: "Start here. Choose neighborhood, reason, department, or a specific case ID.",
        target: () => filtersCard
      },
      {
        title: "Live metrics",
        text: "These KPIs update every time you apply filters, giving quick signal of load and risk.",
        target: () => kpiRow
      },
      {
        title: "What’s Near Me?",
        text: "Use this button in the field to see high-priority cases within a short walk or drive.",
        target: () => nearMeBtn
      },
      {
        title: "City map",
        text: "Each circle is an open case. Look for clusters of red markers to spot hot spots.",
        target: () => mapPanel
      },
      {
        title: "Priority-ordered queue",
        text: "These are the top 10 cases for your current slice, with priority score and context.",
        target: () => caseListMain
      },
      {
        title: "Replay this tour",
        text: "Need a refresher later? Click here anytime to replay this guide.",
        target: () => tourRestart
      }
    ];

    function clearHighlight() {
      document.querySelectorAll(".tour-highlight")
        .forEach(el => el.classList.remove("tour-highlight"));
    }

    function positionTooltip(targetRect) {
      const tooltipRect = tourTooltip.getBoundingClientRect();
      let top = targetRect.bottom + 10;
      let left = targetRect.left;

      if (left + tooltipRect.width > window.innerWidth - 12) {
        left = window.innerWidth - tooltipRect.width - 12;
      }
      if (top + tooltipRect.height > window.innerHeight - 12) {
        top = targetRect.top - tooltipRect.height - 10;
      }
      if (top < 8) top = 8;
      if (left < 8) left = 8;

      tourTooltip.style.top = top + "px";
      tourTooltip.style.left = left + "px";
    }

    function showTourStep(index) {
      clearHighlight();
      if (index < 0 || index >= tourSteps.length) {
        endTour();
        return;
      }
      tourIndex = index;
      const step = tourSteps[index];
      const targetEl = step.target && step.target();
      if (!targetEl) {
        showTourStep(index + 1);
        return;
      }

      tourOverlay.style.display = "block";
      tourTooltip.style.display = "block";
      targetEl.classList.add("tour-highlight");

      tourTooltip.innerHTML = `
        <div class="tour-tooltip-title">${step.title}</div>
        <div class="tour-tooltip-body">${step.text}</div>
        <div class="tour-tooltip-actions">
          ${index > 0 ? '<button class="tour-btn tour-btn-secondary" id="tourPrevBtn">Back</button>' : ""}
          <button class="tour-btn tour-btn-secondary" id="tourSkipBtn">Skip</button>
          <button class="tour-btn tour-btn-primary" id="tourNextBtn">
            ${index === tourSteps.length - 1 ? "Done" : "Next"}
          </button>
        </div>
      `;

      const rect = targetEl.getBoundingClientRect();
      positionTooltip(rect);

      const nextBtn = document.getElementById("tourNextBtn");
      const prevBtn = document.getElementById("tourPrevBtn");
      const skipBtn = document.getElementById("tourSkipBtn");

      if (nextBtn) nextBtn.onclick = () => showTourStep(tourIndex + 1);
      if (prevBtn) prevBtn.onclick = () => showTourStep(tourIndex - 1);
      if (skipBtn) skipBtn.onclick = () => endTour();
    }

    function startTour() {
      showTourStep(0);
    }

    function endTour() {
      clearHighlight();
      tourOverlay.style.display = "none";
      tourTooltip.style.display = "none";
    }

    if (tourRestart) {
      tourRestart.addEventListener("click", () => {
        startTour();
      });
    }
  </script>
</body>
</html>
