<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boston 311 – Demand Trends</title>

  <!-- Load Inter font so this page visually matches the command center -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  >

  <!-- Page-specific CSS for Demand Trends layout and styling -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/demand_trends.css') }}">

  <!-- Chart.js is used to render all the line and bar charts on this page -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- Top navigation bar shared across all dashboard pages -->
  <div class="top-nav">
    <div class="top-nav-left">
      <div class="city-badge">City of Boston</div>
      <div class="top-nav-title">
        <div class="top-nav-title-main">311 Demand Trends &amp; Forecasting</div>
        <div class="top-nav-title-sub">
          Visualize historical volume, spot seasonality, and anticipate upcoming demand.
        </div>
      </div>
    </div>
    <div class="top-nav-right">
      <div class="env-pill">Environment: Internal • Pilot model v1.0</div>
      <div class="system-status-pill">
        <span class="status-dot"></span>
        System online
      </div>
    </div>
  </div>

  <div class="page-shell">
    <!-- Tabs for switching between different parts of the ML dashboard -->
    <div class="page-tabs">
      <a href="/" class="page-tab">Command Center</a>
      <a href="/work-queues" class="page-tab">Work Queues</a>
      <a href="/neighborhoods" class="page-tab">Neighborhood performance</a>
      <a href="/sla-performance" class="page-tab">SLA performance</a>
      <a href="/demand-trends" class="page-tab page-tab-active">Demand trends</a>
      <a href="/analytics" class="page-tab">Analytics</a>
    </div>

    <!-- Hero card that explains how to use the Demand Trends view -->
    <div class="hero-card">
      <div class="hero-title">Demand Trends &amp; Forecasting</div>
      <div class="hero-subtitle">
        Use this view for medium- and long-term planning. Track how 311 volume changes over time,
        understand seasonality, and see a simple baseline forecast for the next few months.
      </div>
      <div class="hero-note">
        Data source: last 12 months of 311 cases from the main service table. Forecast is a
        simple trend-based baseline using recent monthly volumes (falls back to a flat line if there
        isn’t enough history).
      </div>
    </div>

    <!-- Top row: weekly history on the left, forecast on the right -->
    <div class="charts-grid charts-grid-top">
      <!-- Weekly history line chart -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Weekly case volume (last 12 months)</div>
          <div class="chart-subtitle">History only – full weeks, no forecast mixed in.</div>
        </div>
        {% if hist_week_labels|length == 0 %}
          <!-- Graceful message when there is no weekly data -->
          <div class="chart-empty">No historical volume data available yet.</div>
        {% else %}
          <canvas id="weeklyHistoryChart"></canvas>
        {% endif %}
      </div>

      <!-- Forecast line chart -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Monthly trend forecast (next 6 months)</div>
          <div class="chart-subtitle">
            Trend-based baseline forecast using recent monthly case volume. Not an official forecast.
          </div>
        </div>
        {% if fc_week_labels|length == 0 %}
          <div class="chart-empty">No forecast available yet.</div>
        {% else %}
          <canvas id="forecastChart"></canvas>
        {% endif %}
      </div>
    </div>

    <!-- Second row: seasonality + top topics -->
    <div class="charts-grid">
      <!-- Monthly seasonality bar chart -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Seasonality – total volume by month</div>
          <div class="chart-subtitle">
            Month-of-year volume for all request topics combined.
          </div>
        </div>
        {% if month_labels|length == 0 %}
          <div class="chart-empty">No seasonal breakdown available yet.</div>
        {% else %}
          <canvas id="monthlySeasonChart"></canvas>
        {% endif %}
      </div>

      <!-- Top topics horizontal bar chart -->
      <div class="chart-card">
        <div class="chart-header">
          <div class="chart-title">Top request topics (last 12 months)</div>
          <div class="chart-subtitle">
            Total number of cases by reason – top 5 topics.
          </div>
        </div>
        {% if topic_labels|length == 0 %}
          <div class="chart-empty">No topic breakdown available yet.</div>
        {% else %}
          <canvas id="topTopicsChart"></canvas>
        {% endif %}
      </div>
    </div>

    <!-- Bottom full-width chart: seasonal peaks by topic -->
    <div class="chart-card chart-card-full">
      <div class="chart-header">
        <div class="chart-title">Seasonal peaks by topic</div>
        <div class="chart-subtitle">
          Month-of-year case volume for the top request topics (reasons). Use this for planning
          department-specific surges (e.g., street cleaning, enforcement).
        </div>
      </div>
      {% if seasonal_datasets|length == 0 %}
        <div class="chart-empty">No seasonal breakdown available yet.</div>
      {% else %}
        <canvas id="seasonalTopicsFullChart"></canvas>
      {% endif %}
    </div>
  </div>

  <!-- Inline JSON blob that passes all the arrays into the JS file -->
  <script id="demand-data" type="application/json">
    {{
      {
        "histWeekLabels": hist_week_labels or [],
        "histWeekValues": hist_week_values or [],
        "fcWeekLabels": fc_week_labels or [],
        "fcWeekValues": fc_week_values or [],
        "monthLabels": month_labels or [],
        "monthTotals": month_totals or [],
        "monthHasData": month_has_data or [],
        "seasonalRaw": seasonal_datasets or [],
        "topicLabels": topic_labels or [],
        "topicTotals": topic_totals or []
      } | tojson | safe
    }}
  </script>

  <!-- Demand Trends JavaScript that reads the JSON above and renders all charts -->
  <script src="{{ url_for('static', filename='js/demand_trends.js') }}" defer></script>
</body>
</html>