# ml_prioritization_dashboard/cloudbuild.yaml
# Cloud Build pipeline: build dashboard Docker image and deploy to Cloud Run

substitutions:
  _REGION: us-central1
  _REPO_NAME: b311-dashboard-repo
  _IMAGE_NAME: priority-dashboard
  _SERVICE_NAME: priority-dashboard
  _SERVICE_ACCOUNT: b311-ml-ci-sa@boston311-mlops.iam.gserviceaccount.com
  _MODEL_BUCKET: boston311-ml-model-registry
  _MODEL_PREFIX: priority_xgb

steps:
  # 1) Build Docker image for the dashboard
  - name: gcr.io/cloud-builders/docker
    id: Build image
    dir: ml_prioritization_dashboard
    args:
      [
        "build",
        "-t",
        "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:${SHORT_SHA}",
        ".",
      ]

  # 2) Push image to Artifact Registry
  - name: gcr.io/cloud-builders/docker
    id: Push image
    args:
      [
        "push",
        "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:${SHORT_SHA}",
      ]

  # 3) Deploy to Cloud Run
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: Deploy to Cloud Run
    entrypoint: gcloud
    args:
      [
        "run",
        "deploy",
        "${_SERVICE_NAME}",
        "--image",
        "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:${SHORT_SHA}",
        "--platform",
        "managed",
        "--region",
        "${_REGION}",
        "--allow-unauthenticated",
        "--service-account",
        "${_SERVICE_ACCOUNT}",
        "--set-env-vars",
        "MODEL_BUCKET=${_MODEL_BUCKET},MODEL_PREFIX=${_MODEL_PREFIX}",
      ]

images:
  - "${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_REPO_NAME}/${_IMAGE_NAME}:${SHORT_SHA}"
